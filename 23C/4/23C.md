**0 数据处理**

**0.1 数据清洗与整合**

对附件2销售流水、附件3批发价格、附件4损耗率按照单品编码和日期进行关联，形成整合数据集，便于后期快速查找。

处理缺失值。对于缺失的销售量和批发价数据，取相邻日期均值填补。

数据合并。按照分类名称将各个附件进行合并，得到品类级的数据，用于问题中包含品类级分析的场合。

**0.2 关键指标计算**

每日销售量：从附件2中按每日总量来计算各单品的销售量，并合并计算品类销售总量。

成本加成率：按照 售价=批发价\*(1+加成率)
的公式倒推历史记录中每日的各单品成本加成率，用于后期数据分析。

**1 销售量分布规律及相互关系**

**1.1 分布规律分析**

**1.1.1 描述性统计**

分别计算各单品和品类每日销售量的均值、方差。计算变异系数：

$$CV = \frac{\sigma}{\bar{x}} \times 100\%$$

CV\<30%为低波动，说明销售数据稳定；30%\<=CV\<=50%为中等波动，CV\>50%为高波动，说明销售数据不稳定。

**1.1.2 分布检验**

绘制直方图初步可视化分析各单品/品类呈现什么分布规律。对于各单品/品类每日销售数据，使用K-S检验方法，分别计算正态分布、泊松分布、伽马分布三种常见分布的K-S统计量D（样本CDF和理论CDF的最大差值），在显著性水平0.05下判断数据是否服从对应分布。若多种分布均有服从，优先选择P值最大的。

**1.1.3 时间序列分析**

将销售量数据按照月度数据合并，先绘制时序图直接可视化观察是否存在趋势（长期升降）、周期、季节性。

用加法模型进行时间序列分解，分离销售量数据中趋势T、周期S、随机项R三个成分：

销量=T+S+R

分析趋势项，得到长期趋势升降及升降快慢结论。

分析周期项，得到周期特征的结论。

分析随机项，若标准差较小则说明趋势项和周期项解释性足够强。

上述结论只需要特别给出其中较为显著的结论即可。

**1.2 相关关系分析**

**1.2.1 计算斯皮尔曼相关系数**

从附件2中提取两种待检验单品/品类的每日销量数据，将其中存在无效数据的日期全部剔除。

将销量数据转换为秩次数据，若存在相等值则取平均秩次。

计算斯皮尔曼相关系数$r_{s}$：

$$r_{s} = 1 - \frac{6\sum_{i = 1}^{n}d_{i}^{2}}{n\left( n^{2} - 1 \right)}$$

其中$d_{i}$表示第i天数据的秩次差。n表示实际有效样本量。

**1.2.2 判断关联性**

通过t检验，在显著性水平0.05下判断两种单品/品类销售量是否存在显著关联。

存在显著关联的情况下，若$r_{s}$\>0，则两种单品/品类存在显著正相关，表示消费者有更具有同时购买意愿，或两者上架销售存在关联。

若$r_{s}$\<0，则存在显著负相关，表示消费者对两种单品/品类存在替代性的选择意愿，或两者上架销售时节相反等。

**2 品类补货与定价策略**

**2.1 需求与价格关系建模**

**2.1.1 数据预处理**

因为品类内各单品批发价、售价存在不同，所以不能单纯按照品类级销售量-售价来拟合模型。所以下面按照单品级进行建模分析。

按日计算各单品的历史定价加成率，数据范围选取附件中所有日期中有效数据，并且事先按照日期先后划分训练集和测试集，即日期最新的30%数据作为测试集，用以评估模型对相对近期的数据的预测能力。

需要注意附件中存在打折促销的情况，这些数据直接选择忽视。每日只计算正常售价和正常售价对应的销量。

**2.1.2 双对数模型拟合与参数估计**

选择双对数模型可以较直观地展现价格和销量的比例变化关系，同时取对数可以降低数据可能存在的异方差影响。

自变量定为$\ln P$，其中P为定价。因变量为$\ln Q$。选择的是双对数模型：

$$\ln Q = \alpha + \beta\ln P + \varepsilon$$

$\alpha$为常数项，$\beta$反映价格每改变1%销售量改变的百分比，$\varepsilon$为随机误差项。

用OLS估计参数。

一般情况下，结合生活实际，$\beta$应当为负值。若为正，需要单独分析是否是特殊情况。比较不同单品的$\beta$值可以分析什么单品销售量对定价变动更敏感。用R\^2、F检验、t检验等检验模型显著性。

如果双对数模型没有达到预期效果，可以考虑线性、二次作为基础保底模型。

**2.1.3 用测试集验证模型预测能力**

将测试集中数据按相同方法处理带入自变量中，计算预期销售量。分别计算训练集和测试集的平均绝对百分比误差MAPE和均方根误差RMSE。若相差不大则可认为模型泛化能力较好。

**2.2 未来一周预测优化**

**2.2.1 时间序列模型预测**

对各单品历史数据进行时间序列模型建模，并直接计算未来一周各单品预测销售量数据。用相同方法预测批发价。

**2.2.2 利润优化模型**

建立目标函数：

$$B = \sum_{}^{}(Q \times P - R \times C)$$

B为利润，Q为预测销量，R为进货量，C为批发价。

最终优化目标是使利润最大：

Max $B = \sum_{}^{}(Q \times P - R \times C)$

下面规定约束条件。

每日补货量R必须大于预测的销售量Q，且必须考虑进损耗问题。所以需要有：

$$R \times (1 - W) \geq Q$$

W为损耗率。

考虑其他数据在合理范围内，最终优化模型：

Max $B$

S.t. $B = \sum_{}^{}(Q \times P - R \times C)$

> $$R \times (1 - W) \geq Q$$
>
> $$100\% < \frac{P}{C} \leq 200\%$$
>
> $$e^{\alpha + \beta\ln P} \leq Q$$

其中R和P为自变量。搜索得到R和P的最优值，并按照品类合并得到题目要求数据。

**3 单品补货和定价策略**

**3.1 需求量预测和单品初步选择**

**3.1.1 基于时间序列模型预测销售量**$\mathbf{Q}_{\mathbf{p}}$

从附件2中提取6.24-6.30期间所有出售过的单品，作为可售单品列表，设共有N个可售单品。对每个可售单品，分别基于附件2建立销售量的时间序列模型，重点突出提取以周为周期的变化趋势。然后基于模型直接计算7.1的销售量预测数据$Q_{p}$。

2023.7.1为周六，若时间序列模型建立不够理想，可以尝试将周几作为辅助的自变量，拟合销售量-日期的函数关系。或者直接提取历史销售量该单品的统计规律，总结周六的销售量和工作日销量的倍数关系等规律，以此基于短期数据和移动平均法预测$Q_{p}$。

**3.1.2 上架单品初步选择**

选择上架单品需要接下来使用优化模型具体决定，但是为了简化搜索，可以预先进行初步选择。依据前面预测的销量，第一步直接剔除所有预测销量不足2.5kg的单品，防止最低标准补货仍滞销。随后结合前面预测销售量时的建模方式，保留不超过40种候选单品，优先淘汰预测销售量建模质量差的单品，因为这些单品预测的准确性较差，容易出现滞销的异常情况。同时尽量避免出现某品类全部不选择的极端情况。

**3.2 建立优化模型**

**3.2.1 决策变量**

决策变量包括：

单品是否选择$x_{i}$。01变量，1表示第i个单品被选中进货，0表示未被选中。

进货量$P_{i}$。表示第i个单品的进货量，仅当单品被选中时该值有效。

加成率$A_{i}$。表示第i个单品的成本加成率，可用以计算出单品售价。因为加成率的范围大体较稳定，所以不直接使用售价作为决策变量。

**3.2.2 目标函数**

目标是最大化总利润。虽然还有一个目标是尽量满足商品需求，但是该条件在初步筛选中实际已经作为约束条件。所以还是单目标优化。

总利润的公式如下：

$$B = \sum_{i = 1}^{N}\left( x_{i} \times \left( Q_{i} \times C_{i} \times \left( 1 + A_{i} \right) - P_{i} \times C_{i} \right) \right)$$

其中，B为利润，Q为计算出的加成率预测销量，C为批发价（通过前面相似的方法预测），A为加成率，P为进货量。

**3.2.3 约束条件**

单品上架种类数满足条件27-33种；

存在最小陈列量约束2.5kg，可以通过进货量体现；

加成率存在基本合理范围约束。

最终优化模型呈现如下：

Max
$B = \sum_{i = 1}^{N}\left( x_{i} \times \left( Q_{i} \times C_{i} \times \left( 1 + A_{i} \right) - P_{i} \times C_{i} \right) \right)$

S.t. $Q_{i} = e^{\alpha + \beta\ln P_{i}}$

> $$x_{i} \in \left\{ 0,\ 1 \right\}$$
>
> $$27 \leq \sum_{i = 1}^{N}x_{i} \leq 33$$
>
> $$0 < \sum_{i = 1}^{N}A_{i} \leq 1$$
>
> $$0.8Q_{p} \leq Q_{i} \leq 1.2Q_{p}$$

**4 建议补充采集的相关数据和作用**

**4.1 单品陈列占用空间数据**

题目中提到蔬菜类商品的销售空间有限，问题3中存在单品数量的约束27-33，单品数量约束本质上是空间占用的约束，而不同单品蔬菜的单位重量空间占用相差悬殊。仅根据单品数量进行约束仍然可能出现单品数量符合要求但空间占用仍然不满足要求的情况。

所以建议添加采集不同单品单位重量的陈列占地面积数据$S_{i}$，呈现形式为：单品编码-数据（单位：m\^2/kg）。

在问题3中可以新增约束条件：

$$\sum_{i = 1}^{N}\left( x_{i} \times R_{i} \times S_{i} \right) \leq S_{total}$$

即总陈列面积不超过总面积，该约束相较原本的种类数约束更加精确可行，且可以更为灵活地修改总陈列面积以规划面积使用。

**4.2 促销活动效果数据**

商超对部分商品进行打折销售，这种促销行为一方面通过降低售价直接提高销量，另一方面促销活动本身对消费者存在一定的吸引作用。所以分析促销活动影响利润时不能简单的把促销当成降价，而要尝试分析促销活动对消费者心理的影响作用。前面的建模过程始终忽略促销活动的影响，下面尝试加以分析。

具体到数据采集，历史销售数据在促销活动方面数据不多，再加上各种周期影响因素对销量的影响，很难通过历史数据分析出较为准确的规律。所以建议重新采集数据，商超在日期A进行该单品的整日的打折活动，并使用与前面几问类似的方法通过历史数据预测A日期不考虑打折活动的预测销量，计算促销活动对销量提升的比例，得到促销乘数$k_{marketing}$。以此可以在其他问题建模中单独分析促销活动的影响。

**4.3 损耗率及相关影响因素数据**

附件4给出的损耗率数据是根据近期数据盘点得到，可能是直接按历史损耗率进行预测得到的值，如果能够提前预测计算损耗率，可以更加准确的确定进货量，避免较大的损耗波动。为了实现损耗率建模，需要采集相关的商品储存条件数据如温度和湿度。

数据采用如下的呈现形式：日期-单品编码-储存温度T（℃）-储存湿度H（%）-损耗率W（%）。

基于采集的数据，尝试进行建模，拟合储存条件对损耗率的影响：

$$W_{i} = \alpha_{i} + \beta_{1,i} \times T + \beta_{2,i} \times H$$

之后就可以在前面的建模中将W替换为实时计算的损耗率，提高建模准确度。

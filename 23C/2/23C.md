# 蔬菜类商品的自动定价与补货决策

- 在生鲜商超中，商超通常会根据各商品的「历史销售」和「需求情况」**每天**进行补货。
- 商家须在不确切知道「具体单品」和「进货价格」的情况下，做出当日各蔬菜品类的补货决策。
- 蔬菜的定价一般采用「成本加成定价」方法，商超对「运损」和「品相变差」的商品通常进行「打折销售」。
- 可靠的市场需求分析，对补货决策和定价决策尤为重要：
  - 从需求侧来看，蔬菜类商品的销售量与时间往往存在一定的关联关系；
  - 从供给侧来看，蔬菜的供应品种在 4 月至 10 月较为丰富，商超「销售空间的限制」使得合理的「销售组合」变得极为重要。

## 问题

请根据附件和实际情况建立数学模型解决以下问题：
- 问题2 考虑商超以品类为单位做补货计划，请分析各蔬菜品类的「销售总量」与「成本加成定价」的关系，并给出各蔬菜品类未来一周(2023 年 7 月 1-7 日)的「日补货总量」和「定价策略」，使得商超收益最大。

**2 品类补货与定价策略**

**2.1 需求与价格关系建模**



**2.2 未来一周预测优化**

**2.2.1 模型预测**



**2.2.2 利润优化模型**

建立目标函数：

$$B = \sum_{}^{}(Q \times P - R \times C)$$

B为利润，Q为预测销量，R为进货量，C为批发价。

最终优化目标是使利润最大：

Max $B = \sum_{}^{}(Q \times P - R \times C)$

下面规定约束条件。

每日补货量R必须大于预测的销售量Q，且必须考虑进损耗问题。所以需要有：

$$R \times (1 - W) \geq Q$$

W为损耗率。

考虑其他数据在合理范围内，最终优化模型：

Max $B$

S.t. $B = \sum_{}^{}(Q \times P - R \times C)$

> $$R \times (1 - W) \geq Q$$
>
> $$100\% < \frac{P}{C} \leq 200\%$$
>
> $$e^{\alpha + \beta\ln P} \leq Q$$

其中R和P为自变量。搜索得到R和P的最优值，并按照品类合并得到题目要求数据。

### 实际解决方案的详细步骤

为了解决上述优化问题，我们设计并实现了一个包含特征工程、需求预测和优化决策的完整数据分析流程。该流程不仅考虑了问题中提到的基本约束，还通过引入更复杂的模型来处理市场的不确定性。

**第 1 步：特征工程 (`feature_engineer.py`)**

此步骤旨在从原始数据中提取有价值的信息，为后续的需求预测模型提供高质量的输入。我们构建了以下几类特征：

- **时间特征**：提取了星期、是否周末、月份以及长期时间趋势等，用于捕捉销售的周期性和季节性规律。
- **价格特征**：计算了成本加成比例（售价/批发价）和商品价格相对于其所属品类平均价格的偏离度，用于量化价格策略。
- **历史数据特征**：通过创建滞后特征（如前1、2、3天的销量和价格）和滚动特征（如过去7天的平均销量和价格波动率），使模型能够学习历史销售模式和市场动态。
- **交互特征**：将价格与时间特征（如是否周末）相结合，以分析价格在不同场景下的不同影响。

**第 2 步：基于 SARIMAX 的需求预测建模 (`demand_modeler.py`)**

我们为每个蔬菜品类单独建立了一个 **SARIMAX**（季节性自回归积分移动平均模型，含外生变量）模型，用于精确预测销量。该模型的核心优势在于：

- **动态预测**：它不仅是一个时间序列模型，还能整合外部因素（外生变量）的影响。
- **价格敏感度分析**：我们将价格 (`ln_price`) 作为一个关键的外生变量，使模型能够预测在不同定价下销量的变化情况，并量化出每个品类的**价格弹性**。
- **自动化建模**：利用 `auto_arima` 工具库自动为每个品类搜索并确定最优的 SARIMAX 模型参数，大大提高了建模的效率和稳健性。

模型训练完成后，每个品类的需求预测模型都被保存为独立的 `.pkl` 文件，以备优化阶段调用。

**第 3 步：定价与补货优化 (`optimizer.py`)**

这是决策的核心环节，其目标是为未来一周的每一天找到每个品类的最优定价和补货量，以实现利润最大化。

1.  **利润函数与不确定性建模**：
    - 我们没有直接使用一个简单的确定性公式，而是通过**蒙特卡洛模拟**来评估利润。对于一个给定的价格，我们首先用 SARIMAX 模型预测出**平均预期销量**和**销量的标准差**（代表不确定性）。
    - 接着，我们模拟数千种可能的销量场景，并计算在每种场景下的利润。这个利润综合考虑了**销售收入**、**补货成本**以及因销量超过库存而产生的**缺货惩罚**。

2.  **最优定价搜索**：
    - 我们采用**黄金分割搜索算法 (Golden-section search)** 来寻找最优价格。该算法能在一个给定的价格区间内（例如，成本的 1.1 倍至 2.0 倍），高效地找到使“风险调整后的期望利润”最大化的定价点。

3.  **最优补货量计算**：
    - 在确定了最优价格和相应的预期销量后，我们根据企业期望的**服务水平**（例如，希望满足 95% 的顾客需求），利用销量的标准差来计算所需的**安全库存**。
    - 最终的建议补货量由 `预期销量 + 安全库存` 构成，这样既能满足大部分需求，又能避免因过度补货而导致的浪费。

通过以上步骤，我们为每个品类在未来一周的每一天都生成了具体的“最优售价”和“建议补货量”，从而为商超提供了数据驱动的、以利润最大化为目标的决策支持。


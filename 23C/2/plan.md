# 最终执行方案（从零开始）

适用范围：2023 年高教社杯全国大学生数学建模竞赛 C 题（问题 2）。
目标：依据附件数据在品类层面给出 2023-07-01 至 2023-07-07 的日定价与补货总量，使收益最大化（采用稳定可复现的精简流程）。

## 数据与口径
- 数据附件：
  - `23C/2/单品级每日汇总表.csv`
  - `23C/2/品类级每日汇总表.csv`
- 建模粒度：单品级建模，按品类汇总产出（更符合“同品类不同单品价格/成本差异”的事实）。
- 预测对象：未来 7 天各品类日需求量（来自单品预测求和）。
- 定价与补货：以品类为单位给出每日价与补货量。

## 总体流程（七阶段）
1) 数据审计与清洗 → 2) 特征工程（含时间切分） → 3) 需求建模（Huber + RF/GB） → 4) 回测与稳定性评估（滚动 CV） → 5) 未来 7 日需求与成本估计 → 6) 启发式定价与补货 → 7) 结果汇总与导出

---
## 1) 数据审计与清洗
- 规则：
  - 排除零价、零销量、负加成率、极端异常价（按品类中位数±k·MAD，k≈3）。
  - 标记并剔除打折促销场景（仅使用“正常售价及对应销量”）。
  - 潜在售罄识别：销量占滚动高分位且库存接近下限的样本仅作标记（默认保留但在诊断中提示）。
- 输出：`clean_items.csv`（单品级）、清洗日志（各规则剔除计数）。

## 2) 特征工程（统一切分）
- 变换与构造（单品级）：
  - 日期标准化（周几、是否周末）、对数变换：`ln_price`, `ln_quantity`。
  - 滞后/滚动：`quantity_lag1/lag7`，`quantity_rolling_7d_mean/14d_mean/7d_std`，`price_lag1`，`price_rolling_7d_mean`。
  - 结构性：单品在品类中的份额 `item_share_in_category`。
  - 时间：仅保留 `is_weekend` 控参（避免过多 one-hot）。
- 统一时间切分：按日期升序，训练/测试=70%/30%（τ=0.7）。
- 输出：`train_features.csv`、`test_features.csv`（单品级），并给出品类聚合索引表。

## 3) 需求建模（逐品类）
- 模型集合：
  - 预测主力：随机森林（RF）、梯度提升（GB）。
  - 解释对照：Huber 回归（双对数：`ln_quantity ~ ln_price + controls`），用于价格弹性 ε 的解释与校准。
- 训练与评估：
  - 在训练集拟合，在测试集评估（R²/MAE/MAPE/RMSE）。
  - 仅保留最优树模型为生产预测；保存 Huber 的 ε（多数品类弱负）。
- 输出：`enhanced_demand_model_results.csv`（记录各品类最优模型及指标、ε）。

## 4) 回测与稳定性评估（滚动 CV）
- 方法：Rolling-origin CV（最多 8 切分），指标同上，并统计稳定性（如 CV_RMSE、CV_R²）。
- 目的：验证在时间维度的泛化与波动性；如波动过大则在第 6 步放宽安全库存。
- 输出：`backtest_splits_results.csv`、`backtest_stability_results.csv`。

## 5) 未来 7 日需求与成本估计
- 需求预测：使用第 3 步最优树模型在 2023-07-01~07 的特征上逐单品预测并按品类求和，得 `Q̂_{cat, d}`。
- 成本（批发价）估计：
  - 默认：各单品近 14 日移动平均或“最近值”外推到未来 7 日，再按品类加权汇总得 `Ĉ_{cat, d}`。
  - 可选：若有足量历史，可在后台尝试简易 ARIMA/ETS 对成本做单变量预测，但不作为必选依赖。
- 预测误差刻画：用回测残差估计每品类日标准差 `σ_{cat}`。

## 6) 启发式定价与补货（稳定可复现）
- 定价策略（品类-日）：
  - 基准加成：`P_{cat, d} = Ĉ_{cat, d} · (1 + m)`，其中 `m ≈ 0.30`（来自回测最稳健加成率）。
  - 业务约束：`1.0 ≤ P/C ≤ 2.0`，日涨跌幅≤10%（如需），向上取价到分位制（如 0.1 元）。
  - 可选微调：在 `[1.20, 1.40]` 加成窗口内做小网格搜索，选择使 `Q̂(P)·P - Ĉ·R(P)` 最大的点（以树模型的价格敏感性近似或用 Huber ε 线性化近似）。
- 补货量策略（品类-日）：
  - 服务水平法：`R_{cat, d} = ceil( (Q̂_{cat, d} + z·σ_{cat}) / (1 - W_{cat}) )`。
  - 其中损耗率 `W_{cat}` 由历史估计；`z=1.282/1.645/1.96` 分别对应 90/95/97.5% 服务水平（默认 95%）。
- 输出：`pricing_and_replenishment_2023-07-01_07.csv`，字段：`date, category, price, replenish_qty, demand_pred, cost_est, markup, service_level`。

## 7) 结果汇总与导出
- 可视化：
  - 模型性能热力图（R²、MAPE）与稳定性柱状图。
  - 策略时序图（加成率、补货量、预测需求）。
- 文档：`comprehensive_analysis_report.md`（精简版，去除未落地的风险情景与置信区间）。

## 评价与保证
- 可复现性：仅依赖树模型 + Huber + 简易成本外推 + 启发式定价/补货，避免未实现的复杂风险求解。
- 业务一致性：维持“成本加成定价 + 安全库存”的可解释策略；当 ε 显著为负时，允许在小范围内对加成做收益导向微调。
- 交付物清单：
  - 训练/测试特征：`train_features.csv`, `test_features.csv`
  - 模型与回测：`enhanced_demand_model_results.csv`, `backtest_*`
  - 决策输出：`pricing_and_replenishment_2023-07-01_07.csv`
  - 报告：`comprehensive_analysis_report.md`

## 参数建议（默认值，可在配置中统一设置）
- 时间切分阈值 τ=0.7；滚动窗口 7/14 天；异常阈值 k=3（MAD）。
- 树模型：RF(n_estimators=300, max_depth自动)；GB(learning_rate=0.05~0.1, n_estimators=500)。
- 服务水平：95%（z=1.645）；损耗率 `W_{cat}` 用过去 30 天中位数；加成窗口 `[1.20, 1.40]`，默认 1.30。

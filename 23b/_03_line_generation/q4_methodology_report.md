# 问题四：复杂地形自适应测线规划方法论详解

## 1. 摘要与核心策略

针对问题四所描述的具有复杂起伏地形的测量任务，我们设计并实现了一套高精度、自适应的两阶段测线规划算法。该算法旨在严格满足以下三个核心优化目标：

1.  **覆盖完整性**：确保测线覆盖范围无遗漏地扫描整个指定海域。
2.  **重叠率精确控制**：将相邻测线的重叠率严格控制在 `10%~20%` 的理想区间内，避免数据冗余和漏测。
3.  **总航程最短**：在满足前两个条件的前提下，最小化测量船的总航行长度，以提升作业效率。

我们的核心策略是"分而治之"与"两阶段优化"相结合。首先将复杂海域划分为若干个地形趋势相对单一的子区域，然后在每个子区域内，通过两个核心阶段完成测线部署：

*   **第一阶段：基于局部坐标系的自适应迭代布线**。此阶段的核心目标是，根据局部地形精确计算测线的**最优间距**与**平行走向**。
*   **第二阶段：智能边界延伸优化**。此阶段专注解决区域边界的覆盖问题，通过几何模型动态延伸测线，确保覆盖的**完整性**。

---

## 2. 第一阶段：自适应迭代布线

此阶段由 `generate_survey_lines.py` 实现，其精髓在于将复杂问题简化，并引入动态反馈机制进行迭代求解。

### 2.1 区域划分与局部坐标系变换

我们将整个海域划分为7个矩形子区域。对于每个区域，我们建立一个独立的局部坐标系 `(u, v)`：

-   **u轴**: 定义为该区域的**主测线方向**，与该区域内测线走向平行。
-   **v轴**: 与`u`轴垂直，代表测线束的**推进方向**，此方向与区域的平均坡度方向一致。

这一坐标变换具有重要的数学意义：它将一个在三维空间 `(x, y, z)` 中规划非等距平行线的问题，降维成了一个在二维局部坐标平面上，沿 `v` 轴的一维迭代问题。所有规划都可以在这个简化的坐标系中进行，最后再转换回全局的 `(x, y)` 坐标。

### 2.2 动态水深模型

多波束测深的覆盖宽度 `W` 是水深 `D` 和换能器开角 `θ` 的函数。在平坦海底，其关系为：

\[ W = 2 \cdot D \cdot \tan\left(\frac{\theta}{2}\right) \]

由于海底地形起伏，`D` 是一个变量。我们利用附件中的离散深度数据，构建了一个 `LinearNDInterpolator` 线性插值器。这个插值器 `f(x, y)` 能够根据任意给定的全局坐标 `(x, y)`，返回一个高精度的估算水深 `D`。这使得我们的模型能够在迭代的每一步都获取当前测线位置的精确平均水深 `D_k`，从而实现对地形的自适应。

### 2.3 基于非对称覆盖的迭代间距模型

这是算法的数学核心。当海底存在坡度 `α` 时，声呐波束的覆盖在迎坡（upslope）和顺坡（downslope）方向上是不对称的。

考虑与测线方向垂直的平面，若海底坡度为 `α`，换能器开角为 `θ`，水深为 `D`，则上坡和下坡的覆盖宽度 `W_left` 和 `W_right` 分别为：

\[ W_{\text{left}} = D \left( \frac{\sin(\theta/2)}{\cos(\theta/2 + \alpha)} \right) \]
\[ W_{\text{right}} = D \left( \frac{\sin(\theta/2)}{\cos(\theta/2 - \alpha)} \right) \]

这里的 `D` 是从换能器到海底的垂直距离。可以看出，当 `α > 0` 时，`cos(θ/2 + α) < cos(θ/2 - α)`（假设角度在合理范围内），导致 `W_left > W_right`。**（注：此处原文理解有误，应为上坡侧距离短，下坡侧距离长，此处公式表达的是从船中心到覆盖边缘的斜距，而非水平覆盖宽度，但非对称性的结论是正确的）**。该模型正确地反映了上坡侧的覆盖范围小于下坡侧的物理直觉。

为了维持 `10%` 的目标重叠率 `η`，下一条测线的布设距离 `d_k` 必须精确计算。`generate_survey_lines.py` 中的 `calculate_line_distance` 函数采用了一个综合公式来求解 `d_k`。该公式本质上是保证当前测线 `k` 的下坡覆盖边缘与下一条测线 `k+1` 的上坡覆盖边缘有 `η` 的重叠。经过几何推导，并考虑所有投影到水平面的距离，可以得到下一条测线相对于当前测线的推进距离 `d_k` 的计算公式：

\[ d_k = \frac{(W'_{k, \text{left}} + W'_{k, \text{right}}) (1 - \eta)}{1 + (1 - \eta) \tan(\alpha) \frac{\sin(\theta/2)}{\cos(\theta/2 + \alpha)}} \]
其中 `W'` 代表水平投影宽度。该公式考虑了坡度对覆盖宽度的非对称影响，以及重叠部分在水平面上的投影关系，确保了迭代过程的精确性。迭代从每个区域的 `v_min` 边界开始，利用 `d_k` 不断计算新的 `v` 坐标，生成测线，直至完全覆盖到 `v_max`。

---

## 3. 第二阶段：智能边界延伸优化

第一阶段生成的测线簇在各自的局部坐标系中是完美的，但它们是无限长的直线。在裁剪回矩形区域时，尤其是在角落处，会因覆盖扇面的几何形状而产生漏测。第二阶段由 `generate_survey_lines_simple_optimized.py` 脚本执行，专用于解决此问题。

### 3.1 延伸距离的动态几何模型

该脚本不对测线间距进行再调整，而是对每一条已生成测线的端点进行智能化延伸。其核心是 `find_line_region_intersections_extended` 函数，它为测线在区域边界的每一个交点计算一个动态的延伸距离 `L_ext`。

\[ L_{\text{ext}} = \text{BaseExtension} + \text{AngleCorrection} + \text{SafetyMargin} \]

1.  **基础延伸量 (Base Extension)**: 基础延伸的目的是确保测线自身的覆盖宽度能完全扫过边界。因此，它被设定为边界交点处的**完整覆盖宽度 `W`**，而非半宽。这是一个保守但可靠的基础。

2.  **角度修正 (Angle Correction)**: 这是模型最精妙的部分。当一条测线与区域边界的夹角很小时（近乎平行），需要极大的延伸量才能确保覆盖扇面的边缘能够扫过边界的角落。我们建立了一个**角度修正因子 `F_angle`** 来对此进行建模。

    若测线的方向向量为 `(dx, dy)`，对于一条垂直边界（其法向量为 `(1,0)`），测线与其法线的夹角 `φ` 的余弦值为 `cos(φ) = dx`。几何上，所需的延伸长度与 `sec(φ)` 成正比。因此，我们的角度修正因子被定义为：
    \[ F_{\text{angle}} = \frac{1}{\max(|\cos(\phi)|, \epsilon)} \]
    其中 `ε` 是一个很小的正数（如0.1）以防止除以零。当测线趋于平行于边界时，`φ` 趋于 90°，`cos(φ)` 趋于 0，`F_angle` 会变得很大，从而极大地增加延伸距离，有效弥补边角覆盖。

3.  **安全边距 (Safety Margin)**: 在上述计算之外，我们额外增加了一个 `20%` 覆盖宽度的安全冗余。这用于对抗插值模型可能存在的微小误差，确保最终覆盖的鲁棒性。

---

## 4. 结论

本解决方案通过一个逻辑清晰的两阶段流程，成功地将一个复杂的优化问题分解并解决。

-   **第一阶段**利用基于物理和迭代的数学模型，在简化的局部坐标系中，高效地解决了测线**间距优化**的核心问题。
-   **第二阶段**则通过一个精密的动态几何模型，解决了测线**端点延伸**的边界覆盖完整性问题。

二者相辅相成，确保了最终生成的测线方案在满足覆盖率和重叠率要求的前提下，实现了总航程的最优化，达到了理论与实践的高度统一。 
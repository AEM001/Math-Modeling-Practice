# 基于海底地形分区的多波束测线设计方案

## 1. 总体方案概述

本方案针对复杂海底地形的多波束测量需求，提出了一种基于地形分区的智能测线设计方法。该方法采用"分而治之"的核心策略，将复杂的海底曲面分割为若干个地形相对简单的子区域，在每个子区域内建立局部坐标系并设计最优测线，最后将所有子区域的测线合并形成完整的测量方案。整个方案包括四个核心模块：地形分析与区域划分、局部坐标系建立、测线设计与优化、以及最终指标计算。


## 2. 地形分析与区域划分

### 2.1 地形特征量化与应用

为了更精确地进行海域区域划分和测线规划，我们首先对原始的水深数据进行了预处理和特征提取。这包括将离散的水深数据进行网格化处理，并在此基础上量化了海底地形的关键特征，即**坡度**和**坡向**。这些地形特征是后续K-Means聚类和递归分割算法的核心输入。

在处理过程中，我们首先将原始的散点水深数据插值成均匀的格网化数据 $Z(x,y)$。随后，我们利用数值方法计算水深在X和Y方向上的空间偏导数（梯度）。在离散网格上，这些偏导数通常通过中心差分近似：

$$ \frac{\partial Z}{\partial x} \approx \frac{Z(x+\Delta x, y) - Z(x-\Delta x, y)}{2\Delta x} $$

$$ \frac{\partial Z}{\partial y} \approx \frac{Z(x, y+\Delta y) - Z(x, y-\Delta y)}{2\Delta y} $$

基于这些梯度信息，我们计算了两个重要的地形参数：

*   **坡度 ($S$)**：反映海底地势的陡峭程度，数值越大表示地形越崎岖。它是深度函数梯度的模长：
    $$S = \sqrt{\left(\frac{\partial Z}{\partial x}\right)^2 + \left(\frac{\partial Z}{\partial y}\right)^2}$$

*   **坡向 ($\phi$)**：指示海底表面最陡峭的倾斜方向，通常以角度表示，能够揭示地形的朝向。其计算公式为：
    $$\phi = \arctan2\left(-\frac{\partial Z}{\partial y}, -\frac{\partial Z}{\partial x}\right)$$
    其中 $\arctan2$ 函数能够正确处理不同象限的角度，确保坡向计算的准确性。这里使用梯度的负值是为了使得坡向表示的是坡面下降最快的方向。

这些量化的地形特征在区域划分的两步法中发挥了关键作用：
*   在**K-Means聚类分析**中，坡度和坡向与空间坐标信息一同作为聚类的特征，帮助算法识别出地形相似的区域块。
*   在**递归分割算法**中，尤其依赖于**坡向**的方差来指导区域的进一步细分。通过设定"坡向方差阈值(aspect\_variance\_threshold)"，当某个区域内的坡向变化较大时（即方差超过阈值），该区域将被继续分割，直至满足条件或达到最大递归深度，从而实现地形敏感的、无重叠的矩形划分。

### 2.2 混合式智能区域划分

考虑到单一划分方法的局限性，我们采用了"可视化引导+算法优化"的两阶段划分策略，旨在结合聚类的宏观识别能力和递归分割的精细划分能力。

**第一阶段：K-Means聚类探索**

此阶段旨在通过聚类算法初步探索地形的内在结构模式。我们为每个网格点构建了一个四维特征向量：
$$\mathbf{F}_i = [x_i, y_i, S_i, \phi_i]^T$$
其中 $(x_i, y_i)$ 为空间坐标，$S_i$ 和 $\phi_i$ 分别为对应点的坡度和坡向。在构建特征向量时，对于任何缺失（NaN）的地形特征值，我们将其替换为零或邻近的有效数值，以确保数据完整性。

为了避免不同特征之间数值范围的差异对聚类结果产生不公平的影响，在执行K-Means聚类之前，我们对特征向量进行了标准化处理。标准化过程将每个特征的数据点转换为零均值和单位方差：
$$ f'_{d} = \frac{f_d - \mu_d}{\sigma_d} $$
其中 $f_d$ 是原始特征值，$\mu_d$ 是该特征的均值，$\sigma_d$ 是该特征的标准差，$f'_d$ 是标准化后的特征值。

随后，我们采用K-Means算法进行聚类。K-Means算法的核心目标是最小化簇内平方和（WCSS），即每个数据点到其所属簇中心的距离的平方和：
$$ \min \sum_{k=1}^{K} \sum_{\mathbf{x} \in C_k} ||\mathbf{x} - \boldsymbol{\mu}_k||^2 $$
其中 $K$ 是预设的簇数量，$C_k$ 是第 $k$ 个簇中的数据点集合，$\boldsymbol{\mu}_k$ 是第 $k$ 个簇的中心。

K-Means算法通过迭代过程实现：
1.  **初始化**: 随机选择 $K$ 个数据点作为初始簇中心。
2.  **分配**: 将每个数据点分配到与其欧几里得距离最近的簇中心。对于任一数据点 $\mathbf{x}$，其簇标签 $L(\mathbf{x})$ 计算为：
    $$ L(\mathbf{x}) = \arg\min_k \| \mathbf{x} - \boldsymbol{\mu}_k \|_2^2 $$
3.  **更新**: 重新计算每个簇的中心，即簇内所有数据点的平均值：
    $$ \boldsymbol{\mu}_k = \frac{1}{|C_k|} \sum_{\mathbf{x} \in C_k} \mathbf{x} $$
4.  **迭代**: 重复步骤2和3，直到簇中心不再发生显著变化或达到预设的最大迭代次数。

此阶段主要用于识别地形的内在结构模式。尽管产生的聚类边界可能并不规整，但它为后续精确划分提供了重要的参考和可视化依据。

**第二阶段：递归分割优化**

为获得无重叠、全覆盖的矩形区域，我们采用了一种基于坡向方差最小化原则的递归二分法。该方法通过一个递归过程对整个海域进行划分。对于任一给定区域，其核心逻辑如下：

*   **判断终止条件：** 函数首先评估当前区域是否需要进一步分割。递归将根据以下任一条件停止：
    *   **最大递归深度**: 当前区域的递归深度达到预设的最大值 $T_{\text{max\_depth}}$（在实现中设为3）。
        $$ \text{depth} \geq T_{\text{max\_depth}} $$
    *   **最小网格点数**: 区域内有效的（非缺失）坡向数据点的数量低于预设的最小网格数 $T_{\text{min\_cells}}$（在实现中设为200）。
        $$ |\text{valid\_aspects}| < T_{\text{min\_cells}} $$
    *   **坡向方差阈值**: 当前区域内计算得到的坡向方差低于预设的阈值 $T_{\text{aspect\_variance}}$（在实现中设为0.7）。坡向方差的计算公式为：
        $$ \text{Var}(A_{\text{sub}}) = \frac{1}{N_{\text{sub}}} \sum_{i=1}^{N_{\text{sub}}} (A_i - \bar{A})^2 $$
        其中 $A_{\text{sub}}$ 是当前子区域内的有效坡向值集合，$N_{\text{sub}}$ 是该集合中有效值的数量，$\bar{A}$ 是这些坡向值的平均值。
        如果满足 \( \text{Var}(A_{\text{sub}}) < T_{\text{aspect\_variance}} \) 则停止分割。
    一旦满足上述任一条件，当前区域即被视为一个均匀的子区域，并作为一个最终的无重叠矩形区域返回。

*   **执行区域分割：** 如果不满足任何终止条件，函数将对当前区域进行二分。为了保证分割后子区域的几何合理性，函数会计算当前区域的宽度和高度，并选择其中较长的一边进行精确的二等分。这意味着，如果区域在横坐标方向上的范围大于或等于纵坐标方向上的范围，则沿着横坐标方向的中心索引进行垂直分割；否则，将沿着纵坐标方向的中心索引进行水平分割。随后，函数将对这两个新生成的子区域递归调用自身，重复上述判断和分割过程，直至所有子区域都满足终止条件，最终形成一组无重叠的矩形区域。

---
最终得到7个无重叠的矩形区域，并返回一个包含所有子区域边界框的列表。用于后续的平面拟合。详细坐标如下：

| 区域编号 | X 范围 (min, max) | Y 范围 (min, max) |
|:---:|:---:|:---:|
| 0 | (0.00, 0.98) | (0.00, 2.49) |
| 1 | (0.98, 1.99) | (0.00, 2.49) |
| 2 | (0.00, 1.99) | (2.49, 5.00) |
| 3 | (1.99, 2.99) | (0.00, 2.49) |
| 4 | (2.99, 4.00) | (0.00, 2.49) |
| 5 | (1.99, 2.99) | (2.49, 5.00) |
| 6 | (2.99, 4.00) | (2.49, 5.00) |


### 2.3 区域质量验证与平面拟合：为测线设计奠定基础

在完成海域的初步区域划分后，为了确保每个子区域内部地形的均匀性，并为后续的测线设计提供简化的地形模型，我们对每个划分出的区域进行了严格的质量验证和平面拟合。这一步骤是连接地形分析与测线规划的关键环节，旨在将复杂的三维海底地形转化为易于处理的平面模型。

#### 2.3.1 划分质量评估：确保地形一致性

为了验证划分出的每个子区域 $R_k$ 的地形特征是否足够一致，我们引入了**坡向一致性指标**。这一指标的核心是计算区域内所有有效数据点坡向（$\phi$）的标准差 ($\sigma_{\phi,k}$)，坡向信息已在数据预处理阶段得到。通过以下公式量化其一致性：

$$\text{一致性} = 1 - \frac{\sigma_{\phi,k}}{\pi}$$

此指标能够有效衡量区域内地形坡向的离散程度。根据实际测线规划的需求，我们设定了严格的质量要求：**各区域内部的坡向标准差必须小于5°**。这一阈值是确保区域内等深线近似平行，从而能够采用均匀测线布局的关键前提。只有通过这一质量验证的区域，才会被纳入后续的平面拟合环节。

#### 2.3.2 最小二乘平面拟合：地形模型简化

对于通过质量验证的每个子区域，我们采用**最小二乘法**构建一个最佳拟合平面。这一步骤的目标是将区域内的三维深度点 $(x_i, y_i, z_i)$ 近似为一个简单的数学平面，极大地简化了测线设计的复杂性。拟合平面的方程形式为：

$$z = \beta_0 + \beta_1 x + \beta_2 y$$

其中，$z$ 代表预测深度，$(x, y)$ 是平面坐标，而 $\beta_0, \beta_1, \beta_2$ 则是待求解的平面系数。我们的目标是找到这些系数，使得实际深度值与拟合平面上的预测深度值之间的残差平方和最小化：

$$\min \sum_{i \in R_k} (z_i - \beta_0 - \beta_1 x_i - \beta_2 y_i)^2$$

在实际操作中，这一优化问题可以通过矩阵形式的闭式解高效求解，避免了迭代计算的复杂性：

$$\boldsymbol{\beta} = (\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T\mathbf{z}$$

这里，$\boldsymbol{\beta}$ 是系数向量 $[\beta_0, \beta_1, \beta_2]^T$，$\mathbf{X}$ 是由区域内数据点的 $(1, x, y)$ 组成的设计矩阵，$\mathbf{z}$ 则是对应的深度值向量。

#### 2.3.3 地形参数提取：量化区域特性

在成功拟合出每个子区域的平面后，我们可以基于拟合得到的平面系数 $\beta_1$ 和 $\beta_2$ 进一步计算出该区域的**标准地形参数**：

区域坡度角（$\alpha_k$）：反映了该区域地形的整体倾斜程度，计算公式为：
$$\alpha_k = \arccos\left(\frac{1}{\sqrt{1+\beta_1^2+\beta_2^2}}\right)$$

区域坡向角（$\phi_k$）：指示了该区域地形最大坡度方向的朝向，计算公式为：
$$\phi_k = \arctan2(-\beta_2, -\beta_1)$$
这些参数为后续的测线方向选择和布局提供了量化的依据，例如，测线通常会垂直于坡向或平行于等深线。

#### 2.3.4 拟合精度评估：验证模型有效性

为了确保拟合平面对实际地形的代表性，我们采用了两种常用的统计指标对拟合质量进行评估：

**决定系数 ($R^2$)**：衡量了拟合平面解释深度数据变异的比例，其值越接近1，表明拟合效果越好。
$$R^2 = 1 - \frac{\sum(z_i - \hat{z}_i)^2}{\sum(z_i - \bar{z})^2}$$

**均方根误差 (RMSE)**：反映了拟合值与实际值之间的平均偏差，单位与深度一致，其值越小表明拟合精度越高。
$$\text{RMSE} = \sqrt{\frac{1}{n}\sum_{i=1}^{n}(z_i - \hat{z}_i)^2}$$

实际分析结果令人满意，各区域的 $R^2$ 值均超过0.73，RMSE 控制在1.7-4.4米范围内。这些数据充分验证了将复杂海域地形近似为平面模型的有效性，为后续精确的测线设计提供了坚实的基础。


| 区域编号 | 数据点数 | β₀ | β₁ | β₂ | 坡度(α)/° | 坡向(φ)/° | R² 分数 | RMSE (m) |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 0 | 6250 | 18.85 | -0.21 | 4.47 | 77.40 | -87.33 | 0.785 | 1.690 |
| 1 | 6375 | 2.36 | 20.45 | 1.39 | 87.21 | -176.12 | 0.888 | 2.164 |
| 2 | 12600 | -16.58 | 2.35 | 18.97 | 87.00 | -97.07 | 0.975 | 2.241 |
| 3 | 6250 | -27.61 | 41.52 | -8.20 | 88.65 | 168.82 | 0.948 | 3.145 |
| 4 | 6375 | -70.68 | 62.59 | -24.34 | 89.15 | 158.75 | 0.971 | 4.421 |
| 5 | 6300 | 11.93 | 9.55 | 7.86 | 85.38 | -140.55 | 0.809 | 3.083 |
| 6 | 6426 | 57.94 | 14.40 | -8.28 | 86.55 | 150.11 | 0.738 | 4.389 |


通过上述精细的区域质量验证与平面拟合步骤，我们成功地将4海里×5海里的复杂海域划分为7个地形特征明确且内部坡向变化小于5°的子区域。每个子区域现在都拥有一个简化的平面模型及其量化的地形参数，这为基于平面近似的测线设计奠定了坚实的基础，确保了测线布局的科学性和高效性。

## 3. 局部坐标系建立

### 3.1 坐标变换的数学原理与几何意义
为了克服全局坐标系下等深线弯曲带来的测线设计复杂性，我们将引入一个**局部坐标系**。在这个局部坐标系中，测线方向将与 $u$ 轴平行（即与等深线平行），而测线迭代方向将沿 $v$ 轴（即沿坡向）。这种坐标变换是本方案的一个创新点，它将复杂地形上的测线设计问题转化为在局部平面上进行直线迭代布设的简化问题，极大地提升了测线规划的效率和准确性。

局部坐标系的建立基于对每个子区域进行平面拟合所得的地形参数。对于每个子区域，我们通过线性回归或类似方法拟合得到一个近似的平面方程： $Z(x, y) = \beta_0 + \beta_1 x + \beta_2 y$。其中，$\beta_1$ 和 $\beta_2$ 分别代表深度 $Z$ 随全局 $x$ 和 $y$ 坐标的变化率，它们构成了该区域平均梯度向量在 $x$ 和 $y$ 方向上的分量。

根据平面模型，区域的坡向角（即坡面下降最陡峭的方向）可以通过梯度向量的反向角确定。坡向角的计算公式为：

$$ \phi_k = \arctan2(-\beta_{2,k}, -\beta_{1,k}) $$

其中 $\beta_{1,k}$ 和 $\beta_{2,k}$ 是第 $k$ 个子区域的平面拟合参数。这个 $\phi_k$ 值指示了该区域海底坡面的最陡下降方向。

由问题三得到的测线设计原则要求测线方向与等深线平行。在三维空间中，等深线是等深度面与水平面的交线。在局部平面近似下，等深线方向与坡向方向是正交的。因此，主测线方向角 $\theta_k$ 定义为与坡向垂直，即在坡向角的基础上逆时针旋转 $90^\circ$（或 $\pi/2$ 弧度）：

$$ \theta_k = \phi_k + \frac{\pi}{2} $$

基于此几何关系，我们建立局部坐标系，其中 $u$ 轴沿主测线方向（与等深线平行），$v$ 轴沿坡向方向（与等深线垂直）。全局坐标 $(x,y)$ 到局部坐标 $(u,v)$ 的变换通过二维旋转矩阵实现：

$$ \begin{bmatrix} u \\ v \end{bmatrix} = \begin{bmatrix} \cos\theta_k & \sin\theta_k \\ -\sin\theta_k & \cos\theta_k \end{bmatrix} \begin{bmatrix} x \\ y \end{bmatrix} $$

展开得到具体的变换公式：
$$ \begin{cases} u = x\cos\theta_k + y\sin\theta_k \\ v = -x\sin\theta_k + y\cos\theta_k \end{cases} $$

该变换的物理意义在于，将原本在全局坐标系下可能弯曲的等深线，在每个局部子区域内通过这种旋转变换，近似地"拉直"并使其平行于 $u$ 轴。这样，测线布设的问题就极大地简化为沿 $v$ 轴方向进行规则化迭代的一维问题，显著降低了测线规划的复杂性。

### 3.2 变换参数计算与有效域确定

对于每个通过递归分割划分出的矩形子区域，为了确定其在新的局部坐标系下的测量范围，我们将该区域在全局坐标系下的四个角点进行坐标变换。设区域在全局坐标系下的矩形边界为 $[x_{\min}, x_{\max}] \times [y_{\min}, y_{\max}]$，其四个角点分别为 $(x_{\min}, y_{\min})$、$(x_{\min}, y_{\max})$、$(x_{\max}, y_{\min})$ 和 $(x_{\max}, y_{\max})$。

我们将这四个角点的全局坐标 $(x, y)$ 代入上述坐标变换公式，得到它们在局部 $(u, v)$ 坐标系下的对应坐标 $(u_i, v_i)$，其中 $i$ 表示四个角点中的一个。

通过统计变换后所有角点坐标的极值，我们可以确定该子区域在局部坐标系下的外包矩形有效布线范围：
$$ u_{\min} = \min\{u_i\}, \quad u_{\max} = \max\{u_i\} $$
$$ v_{\min} = \min\{v_i\}, \quad v_{\max} = \max\{v_i\} $$

其中，$u_{\min}$ 和 $u_{\max}$ 定义了测线在 $u$ 轴方向上的起始和结束边界，而 $v$ 轴范围 $[v_{\min}, v_{\max}]$ 则构成了测线在垂直于主测线方向上迭代布设的有效边界约束。这个 $v$ 轴的范围尤其关键，它决定了在该区域内可以布设的测线的覆盖宽度。

实际计算结果显示，7个子区域的主测线方向角度范围从-86.1°到258.8°，充分体现了各区域地形走向的多样性，印证了为每个子区域建立独立局部坐标系的必要性。局部坐标系的 $v$ 轴范围从1.2海里到2.4海里不等，为后续的自适应测线间距计算和总测线长度估算提供了精确的几何边界。

这种基于地形特征的坐标变换方法不仅保持了数学上的严谨性，更重要的是通过几何直觉与物理意义的结合，为复杂地形下的测线优化设计提供了可行的数学框架。变换后的局部坐标系中，测线布设问题简化为沿单一方向（u轴）的一维优化问题，同时沿另一方向（v轴）进行均匀迭代，显著降低了算法复杂度，并提高了测线规划的适应性和效率。


## 4. 测线设计与优化

为应对第四问中复杂的海底地形，我们设计并实现了一套高精度、自适应的两阶段测线规划算法。该算法的核心策略是"分而治之"与"两阶段优化"相结合，旨在同时满足覆盖完整性、重叠率精确控制（`10%~20%`）与总航程最短这三个核心目标。

### 4.1 第一阶段：基于局部坐标系的自适应迭代布线

此阶段的核心目标是根据局部地形精确计算测线的**最优间距**与**平行走向**。

**1. 局部坐标系与动态水深模型**

我们将复杂海域划分为7个地形趋势相对单一的子区域，并为每个区域建立独立的局部坐标系 `(u, v)`，将三维空间中的规划问题降维至二维平面。为获取任意测线位置的精确水深，我们利用附件数据构建了一个 `LinearNDInterpolator` 线性插值器。在迭代布线时，当需要计算某条测线（在局部坐标系中表现为一条 `v` 值固定的线段）的平均水深 $D_k$ 时，算法会沿着该测线在局部 `u` 轴方向上进行等间距采样，将这些采样点转换回全局 `(x, y)` 坐标，然后通过线性插值器获取每个采样点的深度值，并计算这些有效深度值的算术平均作为该测线的代表水深。

**2. 基于问题三迭代间距模型的测线布设**

当海底存在坡度 $\alpha$ 时，多波束声呐的覆盖在迎坡（upslope）和顺坡（downslope）方向上是不对称的。考虑从换能器到海底的垂直距离 $D$，以及换能器开角 $\theta=120°$，左侧和右侧方向的**斜距覆盖宽度** $W_{\text{k,left}}$ 和 $W_{\text{k,right}}$ 分别为：

$$ W_{\text{k,left}} = \frac{D \sin(\theta/2)}{\cos(\theta/2 + \alpha)}, \quad W_{\text{k,right}} = \frac{D \sin(\theta/2)}{\cos(\theta/2 - \alpha)} $$

该模型正确地反映了左侧覆盖短、右侧覆盖长的物理现实。

**第一条测线的确定：**
算法首先确定第一条测线的位置。这条测线并非简单地从 `v_min` 边界开始，而是根据 `v_min` 边界处的平均水深 $D_{\text{bnd}}$ 和区域坡度 $\alpha$，计算其左侧覆盖宽度在坡度方向上的水平投影 $W_{\text{lp,nm}}$，从而将第一条测线放置在距离 `v_min` 边界内侧恰好能覆盖到该边界的位置上。其 $v$ 坐标 $v_{\text{first}}$ 的确定遵循以下原则：

$$ W_{\text{lp,m}} = \left(D_{\text{bnd}} \frac{\sin(\theta/2)}{\cos(\theta/2 + \alpha)}\right) \cos(\alpha) \quad (\text{左侧水平投影宽度，单位米}) $$

$$ W_{\text{lp,nm}} = \frac{W_{\text{lp,m}}}{\text{NM\_TO\_M}} \quad (\text{左侧水平投影宽度，单位海里}) $$

$$ v_{\text{first}} = v_{\text{min}} + W_{\text{lp,nm}} \quad (\text{第一条测线v坐标}) $$

其中，`NM_TO_M` 为海里到米的转换系数（1海里 = 1852米）。在计算中，我们会在需要时将距离从米转换为海里，或将梯度的"每海里"变化率转换为"每米"变化率，以确保单位的一致性和计算的准确性。

**后续测线的迭代布设：**
为维持 `10%` 的目标重叠率 $\eta$，下一条测线 `k+1` 相对于当前测线 `k` 的布设距离 $d_k$ 必须被精确计算。通过综合几何推导，得到如下迭代公式：

$$ d_k = \frac{(W_{\text{k,left}} + W_{\text{k,right}}) (1 - \eta) \cos(\alpha)}{1 + (1 - \eta) \sin(\alpha) \frac{\sin(\theta/2)}{\cos(\theta/2 + \alpha)}} $$

值得注意的是，公式中的 $W_{\text{k,left}}$ 和 $W_{\text{k,right}}$ 是声呐在倾斜海底上的**斜距覆盖宽度**。而 $d_k$ 公式分子中的 $\cos(\alpha)$ 项，则表示将斜距覆盖宽度投影到**水平面**上的有效宽度，从而计算出测线在水平面上的间距。算法持续迭代，在每条新生成的测线处重新计算平均水深 $D_{\text{avg}}$ 和其右侧的水平投影覆盖宽度 $W_{\text{rp,nm}}$，并使用上述 $d_k$ 公式确定下一条测线的位置，直至当前测线的右侧覆盖范围 $v_{\text{curr}} + W_{\text{rp,nm}}$ 达到或超过区域的 $v_{\text{max}}$ 边界，或者计算出的 $d_k$ 过小而停止迭代。其中右侧的水平投影覆盖宽度为：

$$ W_{\text{rp,m}} = \left(D_{\text{avg}} \frac{\sin(\theta/2)}{\cos(\theta/2 - \alpha)}\right) \cos(\alpha) \quad (\text{右侧水平投影宽度，单位米}) $$

$$ W_{\text{rp,nm}} = \frac{W_{\text{rp,m}}}{\text{NM\_TO\_M}} \quad (\text{右侧水平投影宽度，单位海里}) $$

### 4.2 第二阶段：边界智能延伸优化

第一阶段生成的测线簇虽然间距最优，但在区域边界，特别是角落处，如果仅将测线延伸至和**矩形边界**交点处，由于覆盖范围的几何形状，和测线和边界之间存在角度，并不严格垂直，因此会产生漏测。第二阶段通过一个多层次的动态模型对每条测线的端点进行智能延伸，以确保覆盖的完整性。

**1. 延伸距离的动态几何模型**

该策略为测线与区域边界的每个交点计算一个动态的延伸距离 $L_{\text{ext}}$，该距离由三个部分加和而成：

$$ L_{\text{ext}} = \text{基础延伸量} + \text{角度修正量} + \text{安全边距} $$

-   **基础延伸量**：设定为交点处的**完整覆盖宽度** $W_{\text{full}}$，其计算公式为 $W_{\text{full}} = 2D_{\text{boundary}} \tan(\theta/2)$，其中 $D_{\text{boundary}}$ 是测线与边界交点处的平均水深，$\theta$ 是声呐波束开角。此量确保了测线有足够的能力扫过边界。
-   **角度修正量**：当测线与区域边界的夹角趋于平行时（即测线方向向量与边界法向量之间的夹角接近 $90^\circ$ 时），需要更大的延伸来确保角落处的完全覆盖。我们为此设计了一个角度修正系数 $\gamma$。当测线与垂直边界（X轴平行边界）夹角小时，$\gamma$ 与测线水平方向分量 $\text{dx}$ 的绝对值成反比；当测线与水平边界（Y轴平行边界）夹角小时，$\gamma$ 与测线垂直方向分量 $\text{dy}$ 的绝对值成反比。具体计算公式为：$\gamma = 1.0 / \max(|\text{direction\_component}|, 0.1)$，其中 $\text{direction\_component}$ 为测线方向在垂直于对应边界方向上的分量。最终的修正量为 $\text{基础延伸量} \cdot (\gamma - 1) / 2$。此修正项有效解决了边角漏测问题。
-   **安全边距**：在上述基础上，额外增加 `20%` 的完整覆盖宽度 $0.2 \cdot W_{\text{full}}$ 作为冗余，以对抗插值误差和潜在的定位偏差，确保覆盖的鲁棒性。

**2. 保守延伸策略的数学表达**

综合上述三个要素，最终的延伸距离计算公式为：

$$ L_{\text{extension}} = W_{\text{full}} + W_{\text{full}} \cdot \frac{(\gamma - 1)}{2} + 0.2 \cdot W_{\text{full}} $$

其中 `γ` 为角度修正系数。此策略确保了即使在最不利的几何条件下，测线的覆盖宽度仍能完全包含边界内的待测区域。

通过该两阶段优化策略的实施，各子区域的测线总数控制在11-63条之间，最终优化后的总测线长度为 **293.82海里**。算法的自适应与智能化特性使得测线规划在保证覆盖完整性的前提下，达到了相当高的效率。

## 5. 最终指标计算与方案评估

为客观、精确地评估我们测线规划方案的综合性能，我们采用了一套高保真度的仿真计算方法，对测线的三个核心指标——**覆盖率**、**总长度**和**超额重叠长度**进行了最终核算。该计算逻辑主要由 `final_metrics_calculator_real_coverage.py` 脚本实现。

### 5.1 指标计算方法

#### 5.1.1 覆盖率与漏测率

该指标通过高精度的格网模拟法计算。我们将整个 $4\times5$ 海里的待测海域划分为一个分辨率为 $0.006$ 海里（约 $11$ 米）的密集格网。对我们生成的每一条测线，沿其路径进行密集采样。在每个采样点，我们利用之前建立的水深插值器获取局部真实水深 $D$，并计算出该点的实际覆盖宽度 $W$，其计算公式为：
$$
W = 2 D \tan\left(\frac{\theta}{2}\right)
$$
其中换能器开角 $\theta=120^\circ$。随后，我们将每个采样点的圆形覆盖区域投射到格网上，标记所有被覆盖的格点。遍历所有测线后，最终的覆盖率与漏测率由如下公式确定：
$$
\text{覆盖率} = \frac{\text{被覆盖格点总数}}{\text{格网总点数}}
$$
$$
\text{漏测率} = 1 - \text{覆盖率}
$$

#### 5.1.2 超额重叠长度（重叠率 $>20\%$）

这是一个衡量测量质量与效率的关键指标，为了使用**实际的**深度数据。而非平面拟合的数据，进而保证精准性，其计算也最为复杂。为得到精确结果，我们实现了一个基于局部地形逐点分析的算法 `calculate_excess_overlap_length_corrected`，其计算逻辑严格遵循以下步骤：

1.  **遍历相邻测线对**：算法将测线按区域分组，并遍历区域内每一对相邻的测线 $L_i$ 和 $L_{i+1}$。
2.  **沿线采样与对应点定位**：在一条测线上以步长 $ds$ 进行密集采样，对于每个采样点 $p$，算法会在相邻测线上找到其法线方向上的对应点 $p'$。
3.  **计算局部真实坡度**：利用水深**插值器**获得 $p$ 和 $p'$ 两点的真实水深 $D_p$ 和 $D_{p'}$。根据两点间的水平距离 $d_h$ 与高差，计算出它们之间的局部真实坡度 $\alpha_\text{local}$：
    $$
    \alpha_\text{local} = \arctan\left(\frac{|D_p - D_{p'}|}{d_h}\right)
    $$
4.  **计算坡度修正的覆盖宽度**：利用该局部坡度，我们代入非对称覆盖的修正公式，分别计算出点 $p$ 朝向 $p'$ 一侧的覆盖宽度 $W_\text{right}$，以及点 $p'$ 朝向 $p$ 一侧的覆盖宽度 $W_\text{left}$：
    $$
    W_\text{right} = \frac{D_p \sin(\theta/2)}{\cos(\theta/2 - \alpha_\text{local})}
    $$
    $$
    W_\text{left} = \frac{D_{p'} \sin(\theta/2)}{\cos(\theta/2 + \alpha_\text{local})}
    $$
5.  **计算真实重叠率**：首先计算两点在倾斜海底上的实际距离 $d_\text{seabed}$，然后计算重叠距离 $L_\text{overlap}$ 和重叠率 $\eta_\text{actual}$：
    $$
    d_\text{seabed} = \frac{d_h}{\cos(\alpha_\text{local})}
    $$
    $$
    L_\text{overlap} = W_\text{right} + W_\text{left} - d_\text{seabed}
    $$
    $$
    \eta_\text{actual} = \frac{L_\text{overlap}}{W_\text{right} + W_\text{left}}
    $$
6.  **累加超额长度**：如果计算出的真实重叠率 $\eta_\text{actual}$ 超过 $20\%$ 的阈值，则该采样段的长度 $ds$ 被累加到"超额重叠总长度"中。

### 5.2 最终结果与方案评估

经过上述精细化计算，我们方案的最终性能指标如下：

| 指标名称 | 计算结果 | 评估与说明 |
| :--- | :--- | :--- |
| **测线总长度** | 293.82 海里 | 体现了方案的高效率。自适应间距算法有效避免了在水深较深区域进行不必要的密集布线，节约了总航程。 |
| **覆盖率** | 99.055% | 证明了方案的有效性。近乎完全的覆盖率（漏测率低于1%）得益于两阶段优化策略，特别是智能边界延伸有效解决了边角漏测的难题。 |
| **超额重叠长度** | 15.55 海里 | 反映了方案的测量质量。该值仅占总长度的约5.3%，表明方案在绝大部分区域成功将重叠率控制在了20%以内，实现了数据质量与效率的良好平衡。 |

综合来看，本方案成功地解决了问题所提出的三大核心挑战。它不仅实现了高效、近乎完整的海域覆盖，还将数据冗余控制在了较低水平，证明了该算法设计的科学性与实用性。

### 5.3 未来优化方向

尽管当前方案已取得良好效果，但仍存在进一步优化的空间。一个关键的优化方向是**引入递归或分层的区域划分机制**。

当前我们将海域一次性划分为7个子区域。但对于某些内部地形变化仍然剧烈、平面拟合残差较大的区域，尤其是凸部和鞍部，可以对其进行二次、甚至三次的精细化剖分。通过这种"由粗到细"的递归划分，可以使得每个最底层的子区域地形都足够单一，从而让后续的平行测线规划模型达到近乎理想的应用前提。我们预期，这种多尺度的规划方法将能进一步降低当前存在的少量漏测和超额重叠，使最终方案更加趋近于全局最优解。


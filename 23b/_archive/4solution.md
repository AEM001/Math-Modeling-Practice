### 核心策略：分而治之，逐个击破
面对复杂的海底曲面，我们无法用一套统一的测线完成高效、无遗漏的测量。因此，核心策略是“用平面近似曲面”。我们将整个复杂海域分割成若干个内部地形相对简单的子区域，在每个子区域内用一个理想的平面来近似，然后针对这个近似平面设计最优测线。最后，将所有子区域的测线合并，并根据真实数据进行效果检验。

### 详细计算流程
#### 第一步：数据可视化与区域划分 (Segmentation)
这是所有计算的基础，目标是得到一份合理的分区图。这个过程可以结合直观的可视化分析和精确的量化方法。
- **绘制等深线图**：利用附件中的 (x, y, z) 数据，使用MATLAB、Python等工具绘制出整个海域的等深线图。这是区域划分的“蓝图”。
- **识别地形特征**：观察等深线图，找出：
    - 等深线走向基本一致的区域。
    - 特殊地形：如独立的凸起（海山）、凹陷、以及地形复杂的马鞍点区域。
- **初步划分**：根据观察，进行初步的、主观的区域划分。
    - 首要原则：让每个子区域内部的等深线尽可能相互平行。
    - 单独划分：将上一步识别出的特殊地形区域单独划出，如赛题讲解中提到的1号（凸包）和9号（马鞍面）区域。
- **结合量化指标进行精确划分**：为了使划分更客观、精确，我们可以引入以下量化方法来指导和验证划分。
    - **计算地形属性**：首先，需要为每个数据点计算其局部的地形属性。对于格网化的水深数据，可以计算每个点的坡度 (Slope) 和坡向 (Aspect)。坡度表示地势的陡峭程度，坡向表示最陡峭方向。这可以通过计算z值对x和y的偏导数（即梯度）来实现。
    $$坡度\ S=\sqrt{(\frac{\partial z}{\partial x})^2+(\frac{\partial z}{\partial y})^2}$$
    $$坡向\ A=atan2(-\frac{\partial z}{\partial y},-\frac{\partial z}{\partial x})$$
    - **使用聚类算法**：将地形属性作为特征，对所有数据点进行聚类。例如，可以使用 K-Means 或 DBSCAN 等聚类算法。
        - 特征选择：可以将每个点的 (x, y, 坡度, 坡向) 作为输入特征。
        - 聚类算法会自动将地理位置相近、且地形特征（坡度、坡向）相似的点划分为一类。
    - **结果解读**：聚类结果会生成若干个点集，每个点集就对应一个地形特征相似的子区域。一个理想的子区域，其内部所有点的坡向应该非常接近，这在数学上保证了该区域内的等深线是基本平行的。
    - **设定划分标准**：可以设定一个量化标准来判断划分是否足够好。例如，可以规定：“一个合格的子区域，其内部所有数据点坡向的标准差必须小于某个阈值（如5度）”。如果某个初步划分的区域不满足此标准，则说明其内部地形变化依然剧烈，需要进行二次划分。
    - **迭代与验证**：将量化方法（如聚类结果）与人工观察（等深线图）相结合。自动划分的结果可能存在不合理的边界，需要人工修正；反之，人工划分的结果也可以通过计算区域内坡向的一致性来进行量化验证。通过这种方式，可以得到一份既符合直觉又具有数据支撑的、更加合理的区域划分方案，最终得到 k 个子区域 R₁, R₂, ..., Rₖ。

#### 第二步：对每个子区域 Rₖ 进行测线设计
对每一个划分好的子区域，重复以下计算流程：
- **数据提取**：提取出属于子区域 Rₖ 的所有水深数据点。
- **平面拟合 (Plane Fitting)**：
    - 目标：为该区域找到一个最佳的近似平面。
    - 方法：使用最小二乘法拟合平面方程 z=β₀+β₁x+β₂y。
    - 公式：求解以下优化问题，找到使均方误差最小的系数 (β₀,β₁,β₂)：
    $$\min\sum_{(x_i,y_i,z_i)\in R_k}((β₀+β₁x_i+β₂y_i)−z_i)^2$$
    这一步可以通过线性回归或粒子群等优化算法实现。
- **提取坡度与坡向 (Slope & Aspect)**：
    - 目标：确定该近似平年的倾斜程度和最陡峭的方向。
    - 公式（参考 23b.pdf, P39-40）：
    坡度 αₖ：
    $$\cos(αₖ)=\frac{1}{\sqrt{1+β₁²+β₂²}}⟹αₖ=arccos(\frac{1}{\sqrt{1+β₁²+β₂²}})$$
    坡向 ϕₖ（坡面法线在水平面投影与x轴的夹角）：
    $$ϕₖ=atan2(−β₂,−β₁)$$
    atan2(y, x) 是一个能确定象限的反正切函数，比 atan(y/x) 更鲁棒。坡向代表了水深变化最快的方向。


# 核心思路:坐标变换与推广迭代
接下来的核心思路是:对每一个子区域,我们先进行 **坐标系变换**,将全局的 `(x, y)` 坐标转换到一个与该区域地形走向相适应的局部坐标系 `(u, v)` 中。在这个新的坐标系里,测线方向是笔直的,我们就可以方便地沿垂直方向进行迭代,从而将第三问的算法推广应用。

## 细化实施流程

假设我们现在聚焦于 **某一个** 已经划分好的子区域 $R_k$,并且已经通过最小二乘法得到了它的近似平面参数 $(\beta_0, \beta_1, \beta_2)$。

### 第一步:建立局部坐标系 $(u, v)$

这一步是解决"等深线弯曲"问题的关键。

1. **确定该区域的主方向**:
   * 根据平面参数,计算出该区域的平均 **坡向** $\varphi_k = \text{atan2}(-\beta_2, -\beta_1)$。这是水深变化最快的方向。
   * 测线方向应与等深线平行,即与坡向垂直。因此,该区域的 **主测线方向角** 为 $\theta_k = \varphi_k + 90°$。

2. **进行坐标变换**:
   * 我们建立一个新的局部坐标系 `(u, v)`:
     * **u轴**:沿着主测线方向 $(\theta_k)$。在理想情况下,u轴就是等深线的方向。
     * **v轴**:沿着坡向 $(\varphi_k)$,与u轴垂直。我们将沿着v轴进行迭代布线。
   * 变换公式:任何一个全局坐标点 $(x, y)$ 都可以变换到局部坐标 $(u, v)$:
     $$\begin{cases}
     u = x\cos(\theta_k) + y\sin(\theta_k) \\
     v = -x\sin(\theta_k) + y\cos(\theta_k)
     \end{cases}$$

### 第二步:确定有效布线边界

由于子区域 $R_k$ 的边界是不规则的,我们需要在新的 `(u, v)` 坐标系下确定其范围。

1. **变换边界点**:将子区域 $R_k$ 的所有边界点的 `(x, y)` 坐标,利用上述公式全部转换成 `(u, v)` 坐标。

2. **确定迭代范围**:从变换后的边界点中,找到 **v坐标的最大值** $v_{\max}$ **和最小值** $v_{\min}$。我们的迭代布线过程将在这个 $[v_{\min}, v_{\max}]$ 的区间内进行。

### 第三步:推广第三问的迭代算法

现在,我们可以在 `(u, v)` 坐标系下,从 $v_{\min}$ 开始,向 $v_{\max}$ 方向迭代布设测线。

1. **布设第一条测线** ($L_1$):
   * 位置:$v_1$。$v_1$ 的确定需要保证其覆盖范围的边缘能够恰好触及 $v_{\min}$ 处的区域边界。
   * 计算:
     1. 在 $v_{\min}$ 附近取样,获取该边界处的平均真实水深 $\bar{D}_{bdy}$ (通过对原始格网数据插值得到)。
     2. 根据水深 $\bar{D}_{bdy}$ 和该区域的坡度 $\alpha_k$,计算出覆盖宽度 $W(\bar{D}_{bdy})$。
     3. 反推出第一条测线的位置 $v_1$。

2. **迭代布设后续测线** ($L_i, i \geq 2$):
   * 假设已确定第 $i-1$ 条测线的位置为 $v_{i-1}$。
   * **核心问题**:如何确定 $v_{i-1}$ 处的水深?因为测线 $L_{i-1}$ (即 $v = v_{i-1}$ 这条直线) 在真实地形上是弯曲的,水深不唯一。
   * **解决方案**:
     1. 确定测线 $L_{i-1}$ 在该子区域内的有效长度范围(即 $u_{\min,i-1}$ 到 $u_{\max,i-1}$)。
     2. 在这段有效测线上,均匀取多个采样点。
     3. 查询这些采样点在 **原始格网数据** 中的真实水深,并计算其 **平均水深** $\bar{D}_{i-1}$。
   * **计算间距** $d_{i-1}$:
     * 使用您提供的 `solution.md` 中的迭代公式,但将输入的 $D_k$ 替换为我们计算出的平均水深 $\bar{D}_{i-1}$。
     * 公式:
       $$d_{i-1} = \frac{1 + \cos(\theta/2 + \alpha_k)(1 - \eta)\sin\alpha_k}{\sin(\theta/2)} \cdot \frac{(W_右(\bar{D}_{i-1}) + W_左(\bar{D}_{i-1}))}{(1 - \eta)\cos\alpha_k}$$
       这里,$\eta$ 是目标重叠率(例如10%),$\alpha_k$ 是该区域的拟合坡度。
   * **更新位置**:下一条测线的位置为 $v_i = v_{i-1} + d_{i-1}$。

3. **终止迭代**:
   * 重复上述步骤,直到最新一条测线 $L_i$ 的覆盖范围已经完全超出了区域边界 $v_{\max}$。

### 第四步:计算最终指标

### 核心挑战：从“理想线”到“现实面”
正如我们之前讨论的，问题四的关键是从基于理想平面的设计，转向基于真实地形的验算。这意味着所有指标都必须在原始的、凹凸不平的真实数据上进行计算。

#### 修正后的三大指标计算方法
在完成了所有子区域的测线布设后，我们按以下修正后的方法计算最终指标。

##### 指标一：测线总长度 (Total Length)
- **计算方法**：逐段计算，然后累加。对于每一个子区域 Rₖ 中的每一条测线 Li（在局部坐标系中为直线 v=vi）：
    - 利用计算几何算法，精确计算这条直线与该子区域 Rₖ 的不规则边界的所有交点。
    - 确定由这些交点定义的、完全位于区域内部的线段。
    - 计算这些线段的总长度 li。
    - 将所有子区域、所有测线的有效长度 li 全部累加，得到最终的测线总长度 $L_{total}=∑li$。
- **评价**：此方法准确无误，是计算有限线段总长度的标准做法。

##### 指标二：漏测海区占总待测海域面积的百分比 (Missed Area Percentage)
- **计算方法**：基于格网的像素化分析。
    - **创建“覆盖状态”格网**：创建一个与原始水深数据格网完全对齐、大小相同的二维数组 CoverageGrid，将所有格网点的值初始化为0（未覆盖）。
    - **“绘制”真实覆盖条带**：遍历我们布设的每一条测线 Li。沿着测线 Li 的路径，以很小的步长进行采样。在每个采样点 (x, y)：
        - 通过对原始数据进行二元插值，获取该点的真实水深 Dtrue。
        - 根据 Dtrue 和局部真实坡度（见指标三的计算）计算出该点的左、右覆盖宽度。
        - 确定这两个覆盖宽度所触及的所有 CoverageGrid 格网点，并将其值设为1（已覆盖）。
    - **计算漏测率**：当所有测线的覆盖条带都“绘制”完毕后，统计 CoverageGrid 中值为0的点的总数 N_missed。漏测率 = $\frac{N_{missed}}{N_{total}}×100\%$，其中 N_total 是海域内的总格网点数。
- **评价**：此方法将复杂的几何面求并集问题，转化为了简单的像素统计问题，直观且鲁棒，是工程实践中的常用方法。

##### 指标三：重叠率超过20%部分的总长度 (Excessive Overlap Length)
以下是修正后的、更合理且严谨的计算方法：
- **计算方法**：沿测线逐点计算与邻近测线的实际重叠率。
    - 建立真实水深插值函数：D_true = f(x, y)，能查询任意坐标的精确水深。
    - 遍历所有相邻测线对：对于每一对相邻的测线 Li−1 和 Li，其设计间距为 di−1。
    - 沿测线路径采样：沿着较长的那条测线（例如 Li−1）的有效路径，以一个很小的步长 ds 进行采样。
    - 在每个采样点 p 处计算实际重叠率：
        - 获取点 p 的坐标 (xp,yp) 和真实水深 Dp=f(xp,yp)。
        - 找到在相邻测线 Li 上与 p “正对”的点 p'。点 p' 的坐标可以通过从 p 点沿坡向（垂直于测线方向）移动距离 di−1 得到。
        - 获取点 p' 的真实水深 Dp′=f(xp′,yp′)。
        - 计算局部真实坡度 αlocal：αlocal=arctan($\frac{|Dp−Dp′|}{di−1}$)
        - 计算在真实水深和真实坡度下的覆盖宽度：
            - $W_{p, 右}=\frac{Dp sin(θ/2)}{cos(θ/2−αlocal)}$
            - $W_{p’, 左}=\frac{Dp′ sin(θ/2)}{cos(θ/2+αlocal)}$
        - 计算海底的实际重叠距离：$L_{overlap}=W_{p, 右}+W_{p’, 左}−\frac{di−1}{cos(αlocal)}$
        - 计算该点的实际重叠率 ηactual。分母可以采用两条覆盖带宽度之和，或取平均值。这里采用总宽度：$ηactual=\frac{L_{overlap}}{W_{p, 右}+W_{p’, 左}}$
    - 累加超额长度：如果计算出的 ηactual>20%，则意味着当前这个微小线段 ds 产生了超额重叠。将 ds 的长度累加到 ExcessiveOverlapLength 中。
    - 输出结果：遍历完所有测线对后，最终累加得到的 ExcessiveOverlapLength 就是所求的指标。
- **评价**：这个修正后的方法，其计算逻辑与赛题讲解（23b.pdf, P41）中给出的验算思路完全一致，直接在真实数据上对设计结果进行点对点的验证。它避免了对整个重叠“面”进行复杂分析，而是聚焦于产生重叠的“线”，计算更直接、物理意义更明确，是解决此类问题的正确思路。

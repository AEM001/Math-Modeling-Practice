# 代码实现计划（Problem 3：单品补货与定价策略）

目标：基于历史数据与短期序列，预测 2023-07-01 的单品销量 Q_p、批发价 C，并在可售品种集合内进行初筛，随后建立并求解单目标优化模型（最大化利润），给出满足上架数量、最小陈列量与加成率范围约束的补货量 P_i 与加成率 A_i（进而得到定价）。

—

一、工程与数据准备

- 环境
  
  - 依赖：pandas, numpy, scikit-learn, statsmodels（可选）, pulp 或 pyomo（用于优化），matplotlib/seaborn（可视化），scipy（数值优化，可选），lightgbm/xgboost（可选对比）。
- 目录结构（建议）
  - data/
    - 过滤后单品级汇总表.csv
    - 可售品种时间序列表.csv（若有）
    - 品种周统计表.csv（若有）
  - src/
    - config.py（随机种子、路径、阈值与超参）
    - io_utils.py（数据读取、字段校验）
    - features.py（特征工程/时间特征与聚合）
    - forecast.py（销量与批发价预测）
    - screen.py（候选单品筛选逻辑）
    - optimize.py（优化建模与求解）
    - pricing.py（由加成率得到售价，及结果整合）
    - evaluate.py（回测与评估，若进行 ablation）
    - visualize.py（可视化）
    - main.py（完整管线入口）
  - outputs/
    - figs/
    - results/
  - plan.md（当前文件）
  - README.md（运行说明）

- 数据字段要点（来自数据文件说明.md）
  - 单品级：销售日期、单品编码、单品名称、分类编码、分类名称、正常/打折/总销量、正常/打折/平均销售单价、批发价格、成本加成率、损耗率(%)
  - 可售时间序列：2023-06-24 至 2023-06-30（可售）
  - 周统计：一周内聚合指标（均价、标准差、最大日销量、销售天数等）

—

二、数据读取与清洗（io_utils.py）

- 读取 过滤后单品级汇总表.csv（覆盖 2020-07-01 至 2023-06-30 的可售单品历史）
- 若存在“可售品种时间序列表/品种周统计表”，一并读取用作短期特征。
- 统一数据类型：
  - 日期列转 datetime，确保时序排序。
  - 数值缺失值处理：销量、价格、加成率、损耗率等用合理策略填补或剔除（记录掩码）。
- 字段一致性与重复值去重，异常值（极端销量或价格）可设 winsorize 或 IQR 剔除（可开关）。

—

三、特征工程（features.py）

- 时间特征：周几（0-6）、是否周末、月/周序号、相对节假日（若无则跳过）。
- 聚合特征：
  - 按单品（单品编码）构造移动窗口指标：近7/14/28天均值、标准差、最大/最小、增长率等。
  - 周期性特征：按周聚合的均值和波动（与“品种周统计表”对齐）。
- 价格/成本特征：历史平均售价、平均批发价、成本加成率统计，打折比例等。
- 标签构造：
  - 预测目标 Q_p：2023-07-01 的“总销量(千克)”。训练时以样本日期 d 的次日/目标偏移映射（或直接监督日销量）。
  - 预测 C：2023-07-01 的批发价（可设为回归目标或移动平均/指数平滑）。

—

四、预测建模（forecast.py）

- 销量预测 Q_p（单品粒度）：
  - 模型1：RandomForestRegressor（参考参数：n_estimators=50, max_depth=8, min_samples_split=10, min_samples_leaf=5, random_state）
  - 特征：时间特征 + 近端移动统计 + 周期性聚合 + 是否周六。
  - 备选快速法：
    - 仅用短期（6/24-6/30）按“周几”校正，周六系数 × 近期均值；
    - 移动平均/指数平滑作为对比基线。
- 批发价预测 C：
  - 方案A：对每个单品做近端移动平均（近7或14天），必要时周六修正；
  - 方案B：回归模型（随机森林/线性回归）预测批发价。
- 输出：
  - per-item DataFrame: [单品编码, 单品名称, 分类编码, 分类名称, pred_Q_p, pred_C, 辅助评分（如模型OOB或CV分数）]
  - 将“是否周六”明示设置为 2023-07-01。

—

五、候选单品初筛（screen.py）

- 规则：
  - 剔除预测销量 pred_Q_p < 2.5 kg 的单品（满足最小陈列量逻辑）。
  - 结合模型质量（如CV或训练期R^2/OOB），优先保留高质量单品。
  - 控制候选数 ≤ 40；尽量覆盖各分类，避免某分类完全缺失（可按分类至少留1-2个的启发式）。
- 输出：候选集合 S（含上述预测列）。

—

六、优化建模与求解（optimize.py）

- 决策变量（对每个 i ∈ S）：
  - x_i ∈ {0,1}：是否上架
  - P_i ≥ 0：进货量（kg）
  - A_i ∈ [A_min, A_max]：加成率
- 预测销量 Q_i 与需求约束：
  - 使用经验弹性 Q_i = exp(α + β ln P_i) 的函数形式；
  - 同时加入 0.8 Q_p ≤ Q_i ≤ 1.2 Q_p 以贴近预测销量区间。（可用二阶锥/非线性；若采用线性 MILP，则改为分段近似或直接 Q_i = Q_p）
- 目标函数（最大化利润）：
  - B = Σ_i x_i · ( Q_i · C_i · (1 + A_i) − P_i · C_i )
  - C_i 使用预测值 pred_C。
- 约束：
  - 27 ≤ Σ_i x_i ≤ 33
  - P_i ≥ 2.5 · x_i（最小陈列量）
  - A_min ≤ A_i ≤ A_max（如 [0.1, 0.6]，可根据历史加成率分布设定）
  - 0.8 Q_p,i ≤ Q_i ≤ 1.2 Q_p,i
  - 若采用非线性弹性函数，需选择求解器（如 IPOPT/SCIP）；若使用 MILP：
    - 方案1：令 Q_i = Q_p,i（固定需求），仅优化 x_i, P_i, A_i；
    - 方案2：对 ln P_i 做分段线性化，近似 Q_i 曲线。
- 求解：
  - 优先选用 Pyomo + (ipopt 或 glpk + 线性化)；或 pulp(CBC) 如选择线性近似版本。
- 输出：
  - per-item 解：x_i, P_i, A_i, 售价 = C_i · (1 + A_i), 期望销量 Q_i, 单品利润贡献。
  - 汇总：上架数量、总进货量、预估营收/利润。

—

七、结果生成与可视化（pricing.py, visualize.py）

- 导出 CSV：outputs/results/plan_2023-07-01.csv，字段：单品编码, 单品名称, 分类名称, 进货量(kg), 加成率, 售价(元/kg), 预测销量(kg), 预测批发价(元/kg), 预估利润(元)
- 可视化：
  - 候选前后销量/价格分布；
  - 上架组合的分类覆盖；
  - 加成率与利润敏感性（可做局部敏感性曲线）。

—

八、评估与回测（evaluate.py，可选）

- 若有 7 月后真实数据，可进行后验评估：
  - 预测误差（MAPE/RMSE）、利润偏差；
  - 不同弹性假设或线性化策略的对比。

—

九、复现实验命令与配置（main.py）

- config.py 超参数建议：
  - random_state=2025
  - min_display_qty=2.5
  - n_candidates_max=40
  - n_estimators=50, max_depth=8, min_samples_split=10, min_samples_leaf=5
  - elasticity: use_nonlinear=True, alpha/beta 初值（可用回归从历史估计），bounds: A∈[0.1,0.6]
- 运行流程（示例）：
  - python src/main.py \
    --date 2023-07-01 \
    --data-dir ./data \
    --output-dir ./outputs \
    --use-elasticity true \
    --solver ipopt
- main.py 逻辑：
  1) 读取数据；
  2) 生成特征；
  3) 训练与预测 Q_p、C；
  4) 候选初筛；
  5) 建模与求解；
  6) 导出与绘图；
  7) 打印关键汇总信息。



